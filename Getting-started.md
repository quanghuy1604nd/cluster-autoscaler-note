## **Tổng Quan về Cluster Autoscaler và Cluster API**

Trước khi đi vào chi tiết, hãy hiểu rõ cơ chế hoạt động cốt lõi:

  * **Cluster Autoscaler (CA):** Là một thành phần của Kubernetes, có nhiệm vụ tự động điều chỉnh số lượng node trong một cluster. Nó theo dõi các Pod đang ở trạng thái `Pending` vì không đủ tài nguyên (CPU, memory) và quyết định có cần thêm node mới hay không. Ngược lại, nó cũng tìm kiếm các node đang sử dụng dưới một ngưỡng nhất định trong một khoảng thời gian để loại bỏ chúng nhằm tiết kiệm chi phí.
  * **Cluster API (CAPI):** Là một dự án của Kubernetes cho phép quản lý các cluster Kubernetes một cách khai báo (declarative) bằng các tài nguyên của chính Kubernetes. Thay vì dùng script để tạo máy ảo trên AWS, GCP, v.v., bạn định nghĩa một tài nguyên `MachineDeployment` trong cluster quản lý, và CAPI sẽ lo việc tạo ra các máy ảo tương ứng ở cluster con.
  * **Sự kết hợp:** Khi CA hoạt động với CAPI, nó không trực tiếp tương tác với cloud provider (AWS, Azure, GCP...). Thay vào đó, **CA sẽ điều chỉnh trường `replicas` của tài nguyên `MachineDeployment` hoặc `MachineSet`** trong cluster quản lý. CAPI sẽ theo dõi sự thay đổi này và tự động tạo hoặc xóa các `Machine` (tương ứng là các máy ảo) ở hạ tầng bên dưới.

-----
## Các tham số của Cluster Autoscaler
| Tham số                                              | Mô tả (Tiếng Việt)                                                                                                                                                                                                                                                                                                                                                                                                          | Mặc định                                                     |
| ---------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------ |
| `add-dir-header`                                     | Nếu là true, thêm thư mục của file vào phần đầu các thông điệp log                                                                                                                                                                                                                                                                                                                                                          |                                                              |
| `address`                                            | Địa chỉ để lộ prometheus metrics.                                                                                                                                                                                                                                                                                                                                                                                           | ":8085"                                                      |
| `alsologtostderr`                                    | Ghi log ra lỗi chuẩn và file (không có tác dụng nếu -logtostderr=true)                                                                                                                                                                                                                                                                                                                                                      |                                                              |
| `async-node-groups`                                  | Liệu cluster-autoscaler có tạo và xóa các nhóm node một cách bất đồng bộ hay không. Thử nghiệm: yêu cầu nhà cung cấp cloud hỗ trợ thao tác bất đồng bộ, sử dụng rủi ro tự chịu.                                                                                                                                                                                                                                             |                                                              |
| `aws-use-static-instance-list`                       | CA có nên lấy loại instance khi chạy hay dùng danh sách tĩnh. Chỉ dành cho AWS                                                                                                                                                                                                                                                                                                                                              |                                                              |
| `balance-similar-node-groups`                        | Phát hiện các nhóm node tương tự và cân bằng số lượng node giữa chúng                                                                                                                                                                                                                                                                                                                                                       |                                                              |
| `balancing-ignore-label`                             | Chỉ định label để bỏ qua bên cạnh các label cơ bản và từ cloud provider khi so sánh các nhóm node có giống nhau hay không                                                                                                                                                                                                                                                                                                   | \[]                                                          |
| `balancing-label`                                    | Chỉ định label để dùng so sánh nhóm node thay vì heuristic tích hợp sẵn. Cờ này sẽ vô hiệu hóa logic so sánh khác, và không thể kết hợp với `--balancing-ignore-label`.                                                                                                                                                                                                                                                     | \[]                                                          |
| `bulk-mig-instances-listing-enabled`                 | Lấy các instance của GCE MIG theo nhóm thay vì từng MIG                                                                                                                                                                                                                                                                                                                                                                     |                                                              |
| `bypassed-scheduler-names`                           | Tên các scheduler để bỏ qua. Nếu đặt không rỗng, CA sẽ không đợi pod đạt độ tuổi nhất định trước khi kích hoạt scale-up.                                                                                                                                                                                                                                                                                                    |                                                              |
| `check-capacity-batch-processing`                    | Có bật xử lý hàng loạt cho các yêu cầu check capacity không.                                                                                                                                                                                                                                                                                                                                                                |                                                              |
| `check-capacity-processor-instance`                  | Tên của instance xử lý. Chỉ các ProvisioningRequest có tên này trong tham số "processorInstance" mới được xử lý bởi instance CA này. Chỉ áp dụng cho ProvisioningRequests kiểm tra capacity; nếu không rỗng, xử lý ProvisioningRequests theo nỗ lực tốt nhất không nguyên tử sẽ bị tắt. Không khuyến nghị: Cho đến CA 1.35, các ProvisioningRequests có tiền tố tên này trong class của chúng cũng sẽ được xử lý.           |                                                              |
| `check-capacity-provisioning-request-batch-timebox`  | Thời gian tối đa để xử lý một lô các provisioning request.                                                                                                                                                                                                                                                                                                                                                                  | 10s                                                          |
| `check-capacity-provisioning-request-max-batch-size` | Số lượng tối đa các provisioning request xử lý trong một lô.                                                                                                                                                                                                                                                                                                                                                                | 10                                                           |
| `cloud-config`                                       | Đường dẫn tới file cấu hình của cloud provider. Để trống nếu không dùng.                                                                                                                                                                                                                                                                                                                                                    |                                                              |
| `cloud-provider`                                     | Loại nhà cung cấp cloud. Các giá trị có thể: \[aws,azure,gce,alicloud,cherryservers,cloudstack,baiducloud,magnum,digitalocean,exoscale,externalgrpc,huaweicloud,hetzner,oci,ovhcloud,clusterapi,ionoscloud,kamatera,kwok,linode,bizflycloud,brightbox,equinixmetal,vultr,tencentcloud,civo,scaleway,rancher,volcengine]                                                                                                     | "gce"                                                        |
| `cloud-provider-gce-l7lb-src-cidrs`                  | CIDR mở trong tường lửa GCE cho traffic LB L7 & kiểm tra sức khỏe                                                                                                                                                                                                                                                                                                                                                           | 130.211.0.0/22,35.191.0.0/16                                 |
| `cloud-provider-gce-lb-src-cidrs`                    | CIDR mở trong tường lửa GCE cho traffic LB L4 & kiểm tra sức khỏe                                                                                                                                                                                                                                                                                                                                                           | 130.211.0.0/22,209.85.152.0/22,209.85.204.0/22,35.191.0.0/16 |
| `cluster-name`                                       | Tên cluster đang được autoscale, nếu có                                                                                                                                                                                                                                                                                                                                                                                     |                                                              |
| `cluster-snapshot-parallelism`                       | Mức độ song song tối đa của việc tạo ảnh chụp cluster                                                                                                                                                                                                                                                                                                                                                                       | 16                                                           |
| `clusterapi-cloud-config-authoritative`              | Xử lý flag cloud-config như là nguồn đáng tin cậy (không dùng kubeconfig dự phòng). Chỉ dành cho ClusterAPI                                                                                                                                                                                                                                                                                                                 |                                                              |
| `cordon-node-before-terminating`                     | CA có nên cordon node trước khi terminate trong quá trình downscale không                                                                                                                                                                                                                                                                                                                                                   |                                                              |
| `cores-total`                                        | Số core tối thiểu và tối đa trong cluster, theo định dạng `<min>:<max>`. Cluster Autoscaler sẽ không scale vượt quá giới hạn này.                                                                                                                                                                                                                                                                                           | "0:320000"                                                   |
| `daemonset-eviction-for-empty-nodes`                 | Các pod DaemonSet sẽ được terminate nhẹ nhàng từ node trống                                                                                                                                                                                                                                                                                                                                                                 |                                                              |
| `daemonset-eviction-for-occupied-nodes`              | Các pod DaemonSet sẽ được terminate nhẹ nhàng từ node không trống                                                                                                                                                                                                                                                                                                                                                           | true                                                         |
| `debugging-snapshot-enabled`                         | Có bật tính năng chụp snapshot để debug của cluster autoscaler không                                                                                                                                                                                                                                                                                                                                                        |                                                              |
| `drain-priority-config`                              | Danh sách các cặp `priority:terminationGracePeriodSeconds` phân tách bởi dấu `,`, theo thứ tự `:` - bật priority evictor. Evictor chia pod thành nhóm dựa trên priority và đuổi pod theo thứ tự tăng của nhóm. Không nên dùng cùng `max-graceful-termination-sec` khi bật flag này. Nếu không đặt, evictor mặc định không thứ tự. Priority evictor tái sử dụng logic drain trong kubelet... Ví dụ: `10000:20,1000:100,0:60` |                                                              |
| `dynamic-node-delete-delay-after-taint-enabled`      | Cho phép điều chỉnh động NodeDeleteDelayAfterTaint dựa trên độ trễ giữa CA và api-server                                                                                                                                                                                                                                                                                                                                    |                                                              |
| `emit-per-nodegroup-metrics`                         | Nếu là true, phát ra metrics cho từng node group.                                                                                                                                                                                                                                                                                                                                                                           |                                                              |
| `enable-dynamic-resource-allocation`                 | Có bật logic xử lý đối tượng DRA (Dynamic Resource Allocation) không.                                                                                                                                                                                                                                                                                                                                                       |                                                              |
| `enable-proactive-scaleup`                           | Có bật tắt proactive scale-up không, mặc định là false                                                                                                                                                                                                                                                                                                                                                                      |                                                              |
| `enable-provisioning-requests`                       | CA có xử lý ProvisioningRequest CRs không.                                                                                                                                                                                                                                                                                                                                                                                  |                                                              |
| `enforce-node-group-min-size`                        | CA có nên scale up node group tới kích thước min khi cần không.                                                                                                                                                                                                                                                                                                                                                             |                                                              |
| `estimator`                                          | Loại resource estimator dùng khi scale up. Có thể: \[binpacking]                                                                                                                                                                                                                                                                                                                                                            | "binpacking"                                                 |
| `expander`                                           | Loại node group expander dùng khi scale up. Các giá trị: \[random, most-pods, least-waste, price, priority, grpc]. Chỉ định nhiều giá trị ngăn cách bằng dấu phẩy sẽ gọi các expander theo thứ tự cho đến khi chỉ còn 1 lựa chọn. Nếu vẫn còn tie thì chọn ngẫu nhiên.                                                                                                                                                      | "least-waste"                                                |
| `expendable-pods-priority-cutoff`                    | Các pod có priority thấp hơn ngưỡng sẽ được coi là expendable. Chúng có thể bị kill mà không xem xét khi scale down và không gây scale up. Pod không có priority (PodPriority disabled) không expendable.                                                                                                                                                                                                                   | -10                                                          |
| `feature-gates`                                      | Một tập cặp key=value mô tả feature gates cho tính năng alpha/experimental. Tùy chọn:                                                                                                                                                                                                                                                                                                                                       |                                                              |
| `force-delete-unregistered-nodes`                    | Có cho phép xóa cưỡng bức các node lâu không đăng ký không, bất kể kích thước min của nhóm node.                                                                                                                                                                                                                                                                                                                            |                                                              |
| `force-ds`                                           | Chặn scale-up các nhóm node quá nhỏ để chứa tất cả pod DaemonSet thích hợp.                                                                                                                                                                                                                                                                                                                                                 |                                                              |
| `frequent-loops-enabled`                             | Liệu cluster-autoscaler có kích hoạt vòng lặp mới thường xuyên khi cần không                                                                                                                                                                                                                                                                                                                                                |                                                              |
| `gce-concurrent-refreshes`                           | Số lượng tối đa refresh đồng thời cho mỗi loại đối tượng cloud.                                                                                                                                                                                                                                                                                                                                                             | 1                                                            |
| `gce-expander-ephemeral-storage-support`             | Liệu scale-up có tính đến tài nguyên ephemeral storage cho GCE (Deprecated, sẽ xóa trong 1.30+)                                                                                                                                                                                                                                                                                                                             | true                                                         |
| `gce-mig-instances-min-refresh-wait-time`            | Thời gian tối thiểu phải trôi qua trước khi refresh instance nào đó của GCE MIG                                                                                                                                                                                                                                                                                                                                             | 5s                                                           |
| `gpu-total`                                          | Số lượng tối thiểu và tối đa của các GPU khác nhau trong cluster, theo định dạng `<gpu_type>:<min>:<max>`. Cluster autoscaler sẽ không scale vượt giới hạn này. Có thể dùng nhiều lần. Chỉ hoạt động trên GKE.                                                                                                                                                                                                              | \[]                                                          |
| `grpc-expander-cert`                                 | Đường dẫn tới cert dùng bởi gRPC server qua TLS                                                                                                                                                                                                                                                                                                                                                                             |                                                              |
| `grpc-expander-url`                                  | URL để tới server expander gRPC.                                                                                                                                                                                                                                                                                                                                                                                            |                                                              |
| `ignore-daemonsets-utilization`                      | CA có bỏ qua pod DaemonSet khi tính toán sử dụng tài nguyên để scale down không                                                                                                                                                                                                                                                                                                                                             |                                                              |
| `ignore-mirror-pods-utilization`                     | CA có bỏ qua pod Mirror khi tính toán sử dụng tài nguyên để scale down không                                                                                                                                                                                                                                                                                                                                                |                                                              |
| `ignore-taint`                                       | Chỉ định taint bỏ qua trong template node khi xét scale nhóm node (Deprecated, dùng startup-taints thay thế)                                                                                                                                                                                                                                                                                                                | \[]                                                          |
| `initial-node-group-backoff-duration`                | `initialNodeGroupBackoffDuration` là thời gian backoff đầu tiên khi node mới failed to start.                                                                                                                                                                                                                                                                                                                               | 5m0s                                                         |
| `kube-api-content-type`                              | Kiểu nội dung của request gửi tới apiserver.                                                                                                                                                                                                                                                                                                                                                                                | "application/vnd.kubernetes.protobuf"                        |
| `kube-client-burst`                                  | Giá trị burst cho client kubernetes.                                                                                                                                                                                                                                                                                                                                                                                        | 10                                                           |
| `kube-client-qps`                                    | QPS cho client kubernetes.                                                                                                                                                                                                                                                                                                                                                                                                  | 5                                                            |
| `kubeconfig`                                         | Đường dẫn file kubeconfig chứa authorization và thông tin master.                                                                                                                                                                                                                                                                                                                                                           |                                                              |
| `kubernetes`                                         | Địa chỉ Kubernetes master. Để trống để dùng mặc định                                                                                                                                                                                                                                                                                                                                                                        |                                                              |
| `leader-elect`                                       | Bắt đầu client election và giành leadership trước khi chạy vòng chính. Bật khi chạy component nhân bản để tăng khả năng chịu lỗi.                                                                                                                                                                                                                                                                                           | true                                                         |
| `leader-elect-lease-duration`                        | Thời gian mà các candidate không phải leader sẽ đợi sau khi thấy renewal leadership trước khi cố gắng giành lại slot leader không còn renewal. Đây là tối đa thời gian leader có thể dừng trước khi bị thay bằng candidate khác. Áp dụng nếu election được bật.                                                                                                                                                             | 15s                                                          |
| `leader-elect-renew-deadline`                        | Chuỗi thời gian giữa các lần leader hiện tại cố gắng renew leadership trước khi nó dừng dẫn. Phải nhỏ hơn lease duration. Áp dụng nếu election được bật.                                                                                                                                                                                                                                                                    | 10s                                                          |
| `leader-elect-resource-lock`                         | Loại đối tượng resource dùng để lock trong leader election. Hỗ trợ 'leases'.                                                                                                                                                                                                                                                                                                                                                | "leases"                                                     |
| `leader-elect-resource-name`                         | Tên của object dùng để lock trong leader election.                                                                                                                                                                                                                                                                                                                                                                          | "cluster-autoscaler"                                         |
| `leader-elect-resource-namespace`                    | Namespace của object dùng để lock trong leader election.                                                                                                                                                                                                                                                                                                                                                                    |                                                              |
| `leader-elect-retry-period`                          | Khoảng thời gian client nên đợi giữa các lần cố gắng giành và renew leadership. Áp dụng nếu election được bật.                                                                                                                                                                                                                                                                                                              | 2s                                                           |
| `log-backtrace-at`                                   | Khi log chạm dòng file\:N, emit stack trace                                                                                                                                                                                                                                                                                                                                                                                 | :0                                                           |
| `log-dir`                                            | Nếu không rỗng, write log files vào thư mục này (không có tác dụng nếu -logtostderr=true)                                                                                                                                                                                                                                                                                                                                   |                                                              |
| `log-file`                                           | Nếu không rỗng, dùng file này để log (không có tác dụng nếu -logtostderr=true)                                                                                                                                                                                                                                                                                                                                              |                                                              |
| `log-file-max-size`                                  | Định nghĩa kích thước tối đa file log có thể lớn đến (không có tác dụng nếu -logtostderr=true). Đơn vị MB. Nếu là 0, không giới hạn.                                                                                                                                                                                                                                                                                        | 1800                                                         |
| `log-flush-frequency`                                | Số giây tối đa giữa các lần flush log                                                                                                                                                                                                                                                                                                                                                                                       | 5s                                                           |
| `log-json-info-buffer-size`                          | \[Alpha] Ở định dạng JSON với split stream, các thông báo info có thể được buffer để tăng hiệu năng. Giá trị mặc định 0 bytes để tắt buffering. Kích thước có thể đặt theo bytes hoặc các dạng K/M. Bật LoggingAlphaOptions feature gate để sử dụng.                                                                                                                                                                        |                                                              |
| `log-json-split-stream`                              | \[Alpha] Trong format JSON, ghi error đến stderr và info đến stdout. Mặc định viết một luồng duy nhất đến stdout. Bật LoggingAlphaOptions feature gate để sử dụng.                                                                                                                                                                                                                                                          |                                                              |
| `log-text-info-buffer-size`                          | \[Alpha] Trong format text với split stream, buffer các thông báo info để tăng hiệu năng. Giá trị mặc định 0 bytes tắt buffering. Kích thước có thể theo bytes hoặc các dạng K/M. Bật LoggingAlphaOptions feature gate để sử dụng.                                                                                                                                                                                          |                                                              |
| `log-text-split-stream`                              | \[Alpha] Trong format text, ghi error đến stderr và info đến stdout. Mặc định một luồng duy nhất đến stdout. Bật LoggingAlphaOptions feature gate để sử dụng.                                                                                                                                                                                                                                                               |                                                              |
| `logging-format`                                     | Đặt định dạng log. Các định dạng được phép: "json" (yêu cầu LoggingBetaOptions), "text".                                                                                                                                                                                                                                                                                                                                    | "text"                                                       |
| `logtostderr`                                        | Ghi log đến stderr thay vì file                                                                                                                                                                                                                                                                                                                                                                                             | true                                                         |
| `max-allocatable-difference-ratio`                   | Khác biệt tối đa về tài nguyên allocatable giữa 2 nhóm node tương tự để cân bằng. Giá trị là tỉ lệ của nhóm node nhỏ hơn.                                                                                                                                                                                                                                                                                                   | 0.05                                                         |
| `max-autoprovisioned-node-group-count`               | Số nhóm node tự động provision tối đa trong cluster. Cờ này deprecated và sẽ bị xóa sau.                                                                                                                                                                                                                                                                                                                                    | 15                                                           |
| `max-binpacking-time`                                | Thời gian tối đa dùng cho binpacking cho một scale-up. Nếu binpacking bị giới hạn, scale-up sẽ tiếp tục với các tùy chọn đã tính toán.                                                                                                                                                                                                                                                                                      | 5m0s                                                         |
| `max-bulk-soft-taint-count`                          | Số node tối đa có thể taint/un-taint PreferNoSchedule cùng lúc. Đặt 0 để tắt.                                                                                                                                                                                                                                                                                                                                               | 10                                                           |
| `max-bulk-soft-taint-time`                           | Thời gian tối đa để taint/un-taint node với PreferNoSchedule cùng lúc.                                                                                                                                                                                                                                                                                                                                                      | 3s                                                           |
| `max-drain-parallelism`                              | Số node tối đa cần drain có thể được drain và delete song song.                                                                                                                                                                                                                                                                                                                                                             | 1                                                            |
| `max-empty-bulk-delete`                              | Số node trống tối đa có thể xóa cùng lúc. Deprecated: hãy dùng `--max-scale-down-parallelism`.                                                                                                                                                                                                                                                                                                                              | 10                                                           |
| `max-failing-time`                                   | Thời gian tối đa từ lần chạy autoscaler thành công cuối trước khi restart tự động                                                                                                                                                                                                                                                                                                                                           | 15m0s                                                        |
| `max-free-difference-ratio`                          | Khác biệt tối đa về tài nguyên free giữa 2 nhóm node tương tự để cân bằng. Giá trị là tỉ lệ nhóm nhỏ hơn.                                                                                                                                                                                                                                                                                                                   | 0.05                                                         |
| `max-graceful-termination-sec`                       | Số giây tối đa CA chờ terminate pod khi cố scale down một node. Cờ này không dùng cùng `drain-priority-config`.                                                                                                                                                                                                                                                                                                             | 600                                                          |
| `max-inactivity`                                     | Thời gian tối đa từ hoạt động autoscaler cuối cùng trước khi restart tự động                                                                                                                                                                                                                                                                                                                                                | 10m0s                                                        |
| `max-node-group-backoff-duration`                    | `maxNodeGroupBackoffDuration` là thời gian backoff tối đa cho nhóm node sau khi node mới failed to start.                                                                                                                                                                                                                                                                                                                   | 30m0s                                                        |
| `max-node-provision-time`                            | Thời gian mặc định tối đa CA chờ node được provision — giá trị có thể override theo nhóm node                                                                                                                                                                                                                                                                                                                               | 15m0s                                                        |
| `max-nodegroup-binpacking-duration`                  | Thời gian tối đa dành cho mô phỏng binpacking cho mỗi nhóm node.                                                                                                                                                                                                                                                                                                                                                            | 10s                                                          |
| `max-nodes-per-scaleup`                              | Số node tối đa thêm trong một lần scale-up. Mục đích tối ưu độ trễ thuật toán CA, không phải giới hạn throughput scale-up.                                                                                                                                                                                                                                                                                                  | 1000                                                         |
| `max-nodes-total`                                    | Tổng số node tối đa trong tất cả nhóm node. Cluster autoscaler sẽ không scale vượt giới hạn này.                                                                                                                                                                                                                                                                                                                            |                                                              |
| `max-pod-eviction-time`                              | Thời gian tối đa CA cố gắng evict pod trước khi bỏ                                                                                                                                                                                                                                                                                                                                                                          | 2m0s                                                         |
| `max-scale-down-parallelism`                         | Số node tối đa (cả empty và cần drain) có thể bị xóa song song khi scale down.                                                                                                                                                                                                                                                                                                                                              | 10                                                           |
| `max-total-unready-percentage`                       | Tỉ lệ tối đa node unready trong cluster. Khi vượt mức này, CA dừng hoạt động                                                                                                                                                                                                                                                                                                                                                | 45                                                           |
| `memory-difference-ratio`                            | Khác biệt tối đa về dung lượng memory giữa 2 nhóm node tương tự để cân bằng. Giá trị là tỉ lệ nhóm nhỏ hơn.                                                                                                                                                                                                                                                                                                                 | 0.015                                                        |
| `memory-total`                                       | Số GB dung lượng memory tối thiểu và tối đa trong cluster, theo định dạng `<min>:<max>`. Cluster autoscaler sẽ không scale vượt giới hạn này.                                                                                                                                                                                                                                                                               | "0:6400000"                                                  |
| `min-replica-count`                                  | Số replica tối thiểu mà một replica set hoặc replication controller nên có để cho phép xóa pod khi scale down                                                                                                                                                                                                                                                                                                               |                                                              |
| `namespace`                                          | Namespace chạy cluster-autoscaler.                                                                                                                                                                                                                                                                                                                                                                                          | "kube-system"                                                |
| `new-pod-scale-up-delay`                             | Pod nhỏ hơn tuổi này sẽ không được xem xét scale-up. Có thể tăng cho từng pod qua annotation `cluster-autoscaler.kubernetes.io/pod-scale-up-delay`.                                                                                                                                                                                                                                                                         | 0s                                                           |
| `node-autoprovisioning-enabled`                      | CA có tự động provision nhóm node khi cần không. Cờ này deprecated và sẽ bị xóa sau.                                                                                                                                                                                                                                                                                                                                        |                                                              |
| `node-delete-delay-after-taint`                      | Thời gian chờ trước khi xóa node sau khi taint nó                                                                                                                                                                                                                                                                                                                                                                           | 5s                                                           |
| `node-deletion-batcher-interval`                     | Thời gian CA ScaleDown gom nodes để xóa theo lô.                                                                                                                                                                                                                                                                                                                                                                            | 0s                                                           |
| `node-deletion-delay-timeout`                        | Thời gian tối đa CA chờ gỡ annotation delay-deletion trước khi xóa node.                                                                                                                                                                                                                                                                                                                                                    | 2m0s                                                         |
| `node-group-auto-discovery`                          | Định nghĩa tự động phát hiện nhóm node theo `<discoverer>:[<key>[=<value>]]`. AWS dùng tag ASG, GCE dùng prefix IG với min & max, Azure dùng tag trên VMSS. Có thể dùng nhiều lần.                                                                                                                                                                                                                                          | \[]                                                          |
| `node-group-backoff-reset-timeout`                   | `nodeGroupBackoffResetTimeout` là thời gian sau scale-up failed cuối cùng khi backoff được reset.                                                                                                                                                                                                                                                                                                                           | 3h0m0s                                                       |
| `node-info-cache-expire-time`                        | Thời gian cache Node Info hết hạn cho mỗi mục. Mặc định là 10 năm.                                                                                                                                                                                                                                                                                                                                                          | 87600h0m0s                                                   |
| `nodes`                                              | Thiết lập min,max và dữ liệu cấu hình khác cho nhóm node theo format cloud provider chấp nhận. Có thể dùng nhiều lần. Định dạng: `<min>:<max>:<other...>`                                                                                                                                                                                                                                                                   | \[]                                                          |
| `ok-total-unready-count`                             | Số node unready cho phép, không tính tỉ lệ `max-total-unready-percentage`                                                                                                                                                                                                                                                                                                                                                   | 3                                                            |
| `one-output`                                         | Nếu là true, chỉ viết log theo mức độ severity gốc (thay vì viết đến mọi mức thấp hơn; không có tác dụng nếu -logtostderr=true)                                                                                                                                                                                                                                                                                             |                                                              |
| `parallel-scale-up`                                  | Liệu có cho phép nhiều nhóm node scale-up song song không. Experimental: có thể không hoạt động trên một số cloud provider, sử dụng rủi ro tự chịu.                                                                                                                                                                                                                                                                         |                                                              |
| `pod-injection-limit`                                | Giới hạn tổng số pod khi inject fake pods. Nếu pod không thể schedule đã vượt giới hạn, pod injection sẽ tắt nhưng pod không bị cắt bớt.                                                                                                                                                                                                                                                                                    | 5000                                                         |
| `profiling`                                          | Có bật endpoint debug/pprof không                                                                                                                                                                                                                                                                                                                                                                                           |                                                              |
| `provisioning-request-initial-backoff-time`          | Thời gian backoff ban đầu cho retry ProvisioningRequest sau scale-up failed.                                                                                                                                                                                                                                                                                                                                                | 1m0s                                                         |
| `provisioning-request-max-backoff-cache-size`        | Kích thước cache tối đa cho backoff retry ProvisioningRequest.                                                                                                                                                                                                                                                                                                                                                              | 1000                                                         |
| `provisioning-request-max-backoff-time`              | Thời gian backoff tối đa cho retry ProvisioningRequest sau scale-up failed.                                                                                                                                                                                                                                                                                                                                                 | 10m0s                                                        |
| `record-duplicated-events`                           | Cho phép lặp lại các sự kiện giống nhau trong vòng 5 phút.                                                                                                                                                                                                                                                                                                                                                                  |                                                              |
| `regional`                                           | Cluster là regional.                                                                                                                                                                                                                                                                                                                                                                                                        |                                                              |
| `scale-down-candidates-pool-min-count`               | Số node tối thiểu được xem xét như ứng viên không rỗng bổ sung để scale-down khi các ứng viên trước đó không còn hợp lệ. Khi tính kích thước pool ứng viên, lấy max(#nodes × scale-down-candidates-pool-ratio, scale-down-candidates-pool-min-count).                                                                                                                                                                       | 50                                                           |
| `scale-down-candidates-pool-ratio`                   | Tỉ lệ node được xem xét thêm như ứng viên không rỗng để scale-down khi các ứng viên trước đó không còn hợp lệ. Giá trị thấp → đáp ứng nhanh hơn nhưng độ trễ scale-down chậm hơn; Giá trị cao → có thể ảnh hưởng hiệu năng với cluster lớn. Đặt thành 1.0 để tắt heuristics này — CA sẽ lấy tất cả node như ứng viên bổ sung.                                                                                               | 0.1                                                          |
| `scale-down-delay-after-add`                         | Thời gian chờ sau scale-up để bắt đầu đánh giá scale-down                                                                                                                                                                                                                                                                                                                                                                   | 10m0s                                                        |
| `scale-down-delay-after-delete`                      | Thời gian chờ sau khi xóa node để bắt đầu đánh giá scale-down, mặc định là scanInterval                                                                                                                                                                                                                                                                                                                                     | 0s                                                           |
| `scale-down-delay-after-failure`                     | Thời gian chờ sau khi scale-down thất bại để đánh giá lại                                                                                                                                                                                                                                                                                                                                                                   | 3m0s                                                         |
| `scale-down-delay-type-local`                        | Liệu các flag `--scale-down-delay-after-*` có áp dụng cục bộ theo nhóm node hay toàn cục trên tất cả các nhóm.                                                                                                                                                                                                                                                                                                              |                                                              |
| `scale-down-enabled`                                 | CA có nên scale down cluster không                                                                                                                                                                                                                                                                                                                                                                                          | true                                                         |
| `scale-down-gpu-utilization-threshold`               | Tổng gpu request của các pod chạy trên node chia cho gpu allocatable; nếu dưới mức này thì node có thể scale down. Tính chỉ quan tâm tài nguyên gpu cho node accelerator — cpu và memory bị bỏ qua.                                                                                                                                                                                                                         | 0.5                                                          |
| `scale-down-non-empty-candidates-count`              | Số node không rỗng tối đa trong một lần lặp được xem xét làm ứng viên để scale-down có drain. Giá trị thấp → đáp ứng nhanh hơn nhưng độ trễ scale-down chậm hơn; giá trị cao → có thể ảnh hưởng hiệu năng với cluster lớn (hàng trăm node). Đặt giá trị không dương để tắt heuristics này — CA sẽ không giới hạn số node xem xét.                                                                                           | 30                                                           |
| `scale-down-simulation-timeout`                      | Thời gian chạy mô phỏng scale-down                                                                                                                                                                                                                                                                                                                                                                                          | 30s                                                          |
| `scale-down-unneeded-time`                           | Thời gian một node cần không được dùng để đủ điều kiện scale-down                                                                                                                                                                                                                                                                                                                                                           | 10m0s                                                        |
| `scale-down-unready-enabled`                         | CA có nên scale down các node unready trong cluster không                                                                                                                                                                                                                                                                                                                                                                   | true                                                         |
| `scale-down-unready-time`                            | Thời gian node unready cần không được dùng để đủ điều kiện scale-down                                                                                                                                                                                                                                                                                                                                                       | 20m0s                                                        |
| `scale-down-utilization-threshold`                   | Giá trị tối đa giữa tổng request CPU và memory của pod trên node chia cho allocatable tương ứng, dưới mức này thì node có thể scale down                                                                                                                                                                                                                                                                                    | 0.5                                                          |
| `scale-up-from-zero`                                 | CA có nên scale up khi không có node ready không                                                                                                                                                                                                                                                                                                                                                                            | true                                                         |
| `scan-interval`                                      | Tần suất cluster được đánh giá để scale up hoặc down                                                                                                                                                                                                                                                                                                                                                                        | 10s                                                          |
| `scheduler-config-file`                              | Cho phép thay đổi cấu hình plugin scheduler nội bộ dùng điểm mở rộng PreFilter và Filter                                                                                                                                                                                                                                                                                                                                    |                                                              |
| `skip-headers`                                       | Nếu là true, tránh thêm phần header tiền tố vào log messages                                                                                                                                                                                                                                                                                                                                                                |                                                              |
| `skip-log-headers`                                   | Nếu là true, tránh header khi mở file log (không có tác dụng nếu -logtostderr=true)                                                                                                                                                                                                                                                                                                                                         |                                                              |
| `skip-nodes-with-custom-controller-pods`             | Nếu là true, cluster autoscaler sẽ không bao giờ xóa node có pod thuộc custom controller                                                                                                                                                                                                                                                                                                                                    | true                                                         |
| `skip-nodes-with-local-storage`                      | Nếu là true, cluster autoscaler sẽ không bao giờ xóa node có pod dùng local storage, ví dụ EmptyDir hoặc HostPath                                                                                                                                                                                                                                                                                                           | true                                                         |
| `skip-nodes-with-system-pods`                        | Nếu là true, cluster autoscaler sẽ không bao giờ xóa node có pod từ kube-system (ngoại trừ DaemonSet hoặc mirror pods)                                                                                                                                                                                                                                                                                                      | true                                                         |
| `startup-taint`                                      | Chỉ định taint để bỏ qua trong template node khi xét scale nhóm node (Tương đương `ignore-taint`)                                                                                                                                                                                                                                                                                                                           | \[]                                                          |
| `status-config-map-name`                             | Tên configmap chứa status                                                                                                                                                                                                                                                                                                                                                                                                   | "cluster-autoscaler-status"                                  |
| `status-taint`                                       | Chỉ định taint bỏ qua trong template node khi xét scale nhóm node nhưng node sẽ không bị coi là unready                                                                                                                                                                                                                                                                                                                     | \[]                                                          |
| `stderrthreshold`                                    | Các log ở mức này trở lên sẽ gửi đến stderr khi viết file và stderr (không có tác dụng nếu -logtostderr=true hoặc -alsologtostderr=true)                                                                                                                                                                                                                                                                                    | 2                                                            |
| `unremovable-node-recheck-timeout`                   | Thời gian chờ trước khi kiểm tra lại node không thể remove trước đó                                                                                                                                                                                                                                                                                                                                                         | 5m0s                                                         |
| `user-agent`                                         | User agent sử dụng cho các cuộc gọi HTTP                                                                                                                                                                                                                                                                                                                                                                                    | "cluster-autoscaler"                                         |
| `v`                                                  | Số mức verbosity của log                                                                                                                                                                                                                                                                                                                                                                                                    |                                                              |
| `vmodule`                                            | Danh sách pattern=N phân tách dấu phẩy cho logging theo file (chỉ dùng cho định dạng text log)                                                                                                                                                                                                                                                                                                                              |                                                              |
| `write-status-configmap`                             | CA có ghi thông tin trạng thái vào configmap không                                                                                                                                                                                                                                                                                                                                                                          | true                                                         |


-----
## **Phân Tích Chi Tiết Các Tham Số và Đề Xuất**

Việc cấu hình Cluster Autoscaler cho CAPI chủ yếu được thực hiện qua hai cách:

1.  **Các cờ (flags)** khi khởi chạy pod Cluster Autoscaler.
2.  **Các annotations** trên tài nguyên `MachineDeployment` (MD) hoặc `MachineSet` (MS). **Đây là cách tiếp cận hiện đại và linh hoạt hơn, được khuyến khích sử dụng.**. Điều này có nghĩa là các tham số có thể được dùng riêng cho từng `MachineDeployment`

Dưới đây là phân tích các tham số quan trọng nhất.

### **1. Cấu hình Ngưỡng Scale và Kích Thước Node Group**

Đây là nhóm tham số cơ bản và quan trọng nhất, quyết định giới hạn hoạt động của CA.

| Tên Tham Số/Annotation | Ý Nghĩa | Đề Xuất & Lý Do |
| :--- | :--- | :--- |
| **`cluster.x-k8s.io/cluster-api-autoscaler-node-group-min-size`** | (Annotation trên MD/MS) Số lượng node tối thiểu cho node group này. CA sẽ không bao giờ scale down thấp hơn con số này. | **Đặt \>= 1**. \<br\> **Lý do:** Đảm bảo luôn có ít nhất một node sẵn sàng cho các workload hệ thống hoặc các workload quan trọng, giảm độ trễ khi có yêu cầu đột ngột. Đối với môi trường production, có thể đặt là `2` hoặc `3` để đảm bảo tính sẵn sàng cao (HA). |
| **`cluster.x-k8s.io/cluster-api-autoscaler-node-group-max-size`** | (Annotation trên MD/MS) Số lượng node tối đa cho node group này. CA sẽ không bao giờ scale up vượt quá con số này. | **Đặt theo ngân sách và giới hạn của cloud provider.** \<br\> **Lý do:** Đây là tham số kiểm soát chi phí quan trọng nhất. Cần tính toán cẩn thận dựa trên tải dự kiến và ngân sách cho phép để tránh chi phí phát sinh ngoài ý muốn. |
| **`--scale-down-utilization-threshold`** | (Cờ) Ngưỡng sử dụng tài nguyên (CPU và Memory) của một node. Nếu một node có mức sử dụng dưới ngưỡng này, nó sẽ được xem là một ứng viên để scale down. Giá trị là một số float từ 0.0 đến 1.0. | **Đề xuất: `0.5` - `0.6` (mặc định là `0.5`)**. \<br\> **Lý do:** Giá trị `0.5` (50%) là một điểm khởi đầu an toàn. Nó chừa lại một khoảng trống tài nguyên đủ để hấp thụ các biến động nhỏ về tải mà không cần scale up ngay lập tức. Tăng giá trị này (ví dụ `0.7`) sẽ làm CA scale down mạnh mẽ hơn (tiết kiệm chi phí hơn) nhưng có thể khiến cluster chậm phản ứng với tải tăng đột ngột. |
| **`--scale-down-unneeded-time`** | (Cờ) Khoảng thời gian một node phải ở trạng thái "không cần thiết" (unneeded) trước khi bị CA xóa đi. | **Đề xuất: `10m` - `15m` (mặc định là `10m`)**. \<br\> **Lý do:** Giá trị mặc định `10m` là hợp lý. Nó giúp tránh tình trạng "đập-xây" (thrashing) khi tải biến động nhanh. Nếu tải của bạn rất ổn định, có thể giảm xuống `5m` để tiết kiệm chi phí nhanh hơn. Nếu tải biến động lớn, hãy tăng lên `15m` hoặc `20m` để CA "kiên nhẫn" hơn. |
| **`--max-node-provision-time`** | (Cờ) Thời gian tối đa CA chờ một node mới được thêm vào cluster và chuyển sang trạng thái `Ready`. | **Đề xuất: `20m` - `25m` (mặc định là `15m`)**. \<br\> **Lý do:** Thời gian khởi tạo node phụ thuộc vào cloud provider và quá trình bootstrap (cài đặt CNI, kube-proxy...). `15m` đôi khi hơi ngắn. Tăng lên `20m` hoặc `25m` giúp CA có đủ thời gian chờ, đặc biệt khi kéo các image lớn hoặc cấu hình phức tạp, tránh việc CA từ bỏ một node đang khởi tạo hợp lệ. |

### **2. Kiểm Soát Việc Scale Down**

Nhóm tham số này giúp ngăn chặn CA xóa các node quan trọng hoặc gây gián đoạn dịch vụ.

| Tên Tham Số/Annotation | Ý Nghĩa | Đề Xuất & Lý Do |
| :--- | :--- | :--- |
| **`--skip-nodes-with-local-storage`** | (Cờ) Nếu là `true`, CA sẽ không xóa các node đang chạy các pod sử dụng `emptyDir` hoặc `hostPath` volume. | **Đề xuất: `true` (mặc định là `true`)**. \<br\> **Lý do:** Cực kỳ quan trọng để bảo vệ dữ liệu. Các pod stateful sử dụng local storage sẽ mất dữ liệu nếu node bị xóa. Luôn bật cờ này trừ khi bạn chắc chắn 100% rằng các pod dùng local storage là tạm thời và có thể bị xóa an toàn. |
| **`--skip-nodes-with-system-pods`** | (Cờ) Nếu là `true`, CA sẽ không xóa các node đang chạy các pod trong namespace `kube-system` nếu các pod đó không được quản lý bởi `DaemonSet`. | **Đề xuất: `true` (mặc định là `true`)**. \<br\> **Lý do:** Bảo vệ các thành phần cốt lõi của cluster. Một số pod hệ thống quan trọng (ví dụ: `metrics-server`, `coredns` nếu không chạy dạng deployment) cần được giữ lại. Bật cờ này là một biện pháp an toàn tốt. |
| **`--scale-down-delay-after-add`** | (Cờ) CA sẽ không thực hiện scale down trong khoảng thời gian này sau khi vừa thực hiện scale up. | **Đề xuất: `15m` (mặc định là `10m`)**. \<br\> **Lý do:** Sau khi thêm node mới, tải có thể cần thời gian để cân bằng lại trên toàn cluster. Tăng giá trị này lên một chút (ví dụ `15m`) cho phép cluster ổn định hoàn toàn trước khi CA đưa ra quyết định scale down tiếp theo, tránh thrashing. |

### **3. Chiến Lược Mở Rộng Node Group (Expander)**

Khi có nhiều node group (nhiều `MachineDeployment`) có thể đáp ứng yêu cầu của một pod đang `Pending`, `expander` sẽ quyết định chọn node group nào để scale up.

| Tên Tham Số/Annotation | Ý Nghĩa | Đề Xuất & Lý Do |
| :--- | :--- | :--- |
| **`--expander`** | (Cờ) Xác định chiến lược lựa chọn node group. Các giá trị phổ biến: `random`, `most-pods`, `least-waste`, `priority`. | **Đề xuất: `least-waste` cho môi trường đồng nhất, `priority` cho môi trường không đồng nhất.** \<br\> **Lý do:** \<br\> - **`least-waste`**: Lựa chọn node group mà sau khi thêm node mới, lượng tài nguyên không sử dụng (lãng phí) là ít nhất. Đây là lựa chọn tốt nhất cho việc tối ưu chi phí trong hầu hết các trường hợp. \<br\> - **`priority`**: Cho phép bạn gán một mức độ ưu tiên cho mỗi node group. CA sẽ luôn thử scale up node group có độ ưu tiên cao nhất trước. Rất hữu ích khi bạn có các loại máy khác nhau (ví dụ: máy thường và máy có GPU) và muốn ưu tiên sử dụng loại máy rẻ hơn trước. \<br\> - **`random`**: Chọn ngẫu nhiên, thường chỉ dùng để gỡ lỗi. \<br\> - **`most-pods`**: Ưu tiên node group có khả năng chứa nhiều pod nhất, hữu ích khi muốn tối đa hóa mật độ pod. |
| **`cluster-autoscaler.kubernetes.io/priority`** | (Annotation trên CRD `ClusterAutoscalerNodeGroup` hoặc đôi khi là MD) Gán mức độ ưu tiên cho một node group khi sử dụng `expander=priority`. | **Gán số nguyên, số càng cao ưu tiên càng thấp.** \<br\> **Lý do:** Khi dùng `expander=priority`, bạn phải tạo các CRD `ClusterAutoscalerNodeGroup` tương ứng và đặt annotation này. Ví dụ: gán `priority: 10` cho node group máy thường và `priority: 20` cho node group máy có GPU. CA sẽ luôn chọn node group có `priority: 10` trước. |

### **4. Tham Số Đặc Thù cho Provider 'ClusterAPI'**

| Tên Tham Số/Annotation | Ý Nghĩa | Đề Xuất & Lý Do |
| :--- | :--- | :--- |
| **`--cloud-provider`** | (Cờ) Chỉ định cloud provider mà CA sẽ tương tác. | **Bắt buộc: `clusterapi`**. \<br\> **Lý do:** Đây là cờ để kích hoạt chế độ hoạt động với CAPI. |
| **`--clusterapi-mode`** | (Cờ) Chế độ hoạt động của CA. Có hai giá trị: `MachineDeployment` (mặc định) hoặc `MachineSet`. | **Đề xuất: `MachineDeployment` (mặc định)**. \<br\> **Lý do:** `MachineDeployment` cung cấp cơ chế cập nhật và rollback tương tự như `Deployment` cho Pods, giúp quản lý vòng đời của các node dễ dàng hơn. Sử dụng `MachineSet` chỉ khi bạn cần kiểm soát trực tiếp và không muốn có logic cập nhật tự động của `MachineDeployment`. |

-----
## Tương thích version giữa Kubernetes, Cluster API và Cluster Autoscaler
- **Từ Kubernetes 1.12, các version Kubernetes và Cluster Autoscaler tương thích sẽ trùng với nhau**
- Mỗi một cluster API minor được release sẽ support:
  - 4 Version của Kubernetes cho cụm management (N - N-3)
  - 6 Version của Kubernetes cho cụm workload (N - N-5)
- Nếu một version của Kubernetes được phát hành, Cluster API sẽ hỗ trọ thêm version đó, đồng nghĩa với việc nó sẽ support
  - 5 Version của Kubernetes cho cụm management (N - N-4)
  - 7 Version của Kubernetes cho cụm workload (N - N-6)
- Bảng tương thích version Kubernetes và Cluster API

| Cluster API Version | Status                 | Kubernetes Versions (Management Cluster) | Kubernetes Versions (Workload Cluster) | Cluster Autoscaler Version | Notes |
|---------------------|------------------------|------------------------------------------|----------------------------------------|----------------------------|-------|
| v1.11.x             | Under development      | TBD                                      | TBD                                    | TBD                        | Kubernetes and CA support to be determined upon release. |
| v1.10.x             | Standard support       | v1.29.x - v1.33.x                        | v1.27.x - v1.33.x                      | 1.29.x - 1.33.x            | CA version must match management cluster Kubernetes version (e.g., CA 1.33.x for Kubernetes 1.33.x). Supports Kubernetes v1.33.x from v1.10.1. Maintenance mode starts when v1.12.0 is released; EOL when v1.13.0 is released. |
| v1.9.x              | Standard support       | v1.28.x - v1.32.x                        | v1.26.x - v1.32.x                      | 1.28.x - 1.32.x            | CA version must match management cluster Kubernetes version (e.g., CA 1.32.x for Kubernetes 1.32.x). Supports Kubernetes v1.32.x from v1.9.1. Maintenance mode starts when v1.11.0 is released; EOL when v1.12.0 is released. |
| v1.8.x              | Maintenance mode       | v1.27.x - v1.31.x                        | v1.25.x - v1.31.x                      | 1.27.x - 1.31.x            | CA version must match management cluster Kubernetes version (e.g., CA 1.31.x for Kubernetes 1.31.x). Supports Kubernetes v1.31.x from v1.8.1. Maintenance mode since 2025-04-22 (v1.10.0 release); EOL when v1.11.0 is released. |
| v1.7.x              | EOL                    | v1.26.x - v1.30.x                        | v1.24.x - v1.30.x                      | 1.26.x - 1.30.x            | CA version must match management cluster Kubernetes version. EOL since 2025-04-22 (v1.10.0 release). |
| v1.6.x              | EOL                    | v1.25.x - v1.29.x                        | v1.23.x - v1.29.x                      | 1.25.x - 1.29.x            | CA version must match management cluster Kubernetes version. EOL since 2024-12-10 (v1.9.0 release). |
| v1.5.x              | EOL                    | v1.24.x - v1.28.x                        | v1.22.x - v1.28.x                      | 1.24.x - 1.28.x            | CA version must match management cluster Kubernetes version. EOL since 2024-08-12 (v1.8.0 release). |
| v1.4.x              | EOL                    | v1.23.x - v1.27.x                        | v1.21.x - v1.27.x                      | 1.23.x - 1.27.x            | CA version must match management cluster Kubernetes version. EOL since 2024-04-16 (v1.7.0 release). |
| v1.3.x              | EOL                    | v1.22.x - v1.26.x                        | v1.20.x - v1.26.x                      | 1.22.x - 1.26.x            | CA version must match management cluster Kubernetes version. EOL since 2023-12-05 (v1.6.0 release). |
| v1.2.x              | EOL                    | v1.21.x - v1.25.x                        | v1.19.x - v1.25.x                      | 1.21.x - 1.25.x            | CA version must match management cluster Kubernetes version. EOL since 2023-07-25 (v1.5.0 release). |
| v1.1.x              | EOL                    | v1.20.x - v1.24.x                        | v1.18.x - v1.24.x                      | 1.20.x - 1.24.x            | CA version must match management cluster Kubernetes version. EOL since 2023-03-28 (v1.4.0 release). |
| v1.0.x              | EOL                    | v1.19.x - v1.23.x                        | v1.17.x - v1.23.x                      | 1.19.x - 1.23.x            | CA version must match management cluster Kubernetes version. EOL since 2022-12-01 (v1.3.0 release). |
